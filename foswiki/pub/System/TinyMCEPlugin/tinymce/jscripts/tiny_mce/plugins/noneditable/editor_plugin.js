(function(){var TreeWalker=tinymce.dom.TreeWalker;var externalName="contenteditable",internalName="data-mce-"+externalName;var VK=tinymce.VK;function handleContentEditableSelection(ed){var dom=ed.dom,selection=ed.selection,invisibleChar,caretContainerId="mce_noneditablecaret",invisibleChar="\ufeff";function getContentEditable(node){var contentEditable;if(node.nodeType===1){contentEditable=node.getAttribute(internalName);if(contentEditable&&contentEditable!=="inherit"){return contentEditable}contentEditable=node.contentEditable;if(contentEditable!=="inherit"){return contentEditable}}return null}function getNonEditableParent(node){var state;while(node){state=getContentEditable(node);if(state){return state==="false"?node:null}node=node.parentNode}}function getParentCaretContainer(node){while(node){if(node.id===caretContainerId){return node}node=node.parentNode}}function findFirstTextNode(node){var walker;if(node){walker=new TreeWalker(node,node);for(node=walker.current();node;node=walker.next()){if(node.nodeType===3){return node}}}}function insertCaretContainerOrExpandToBlock(target,before){var caretContainer,rng;if(getContentEditable(target)==="false"){if(dom.isBlock(target)){selection.select(target);return}}rng=dom.createRng();if(getContentEditable(target)==="true"){if(!target.firstChild){target.appendChild(ed.getDoc().createTextNode("\xa0"))}target=target.firstChild;before=true}caretContainer=dom.create("span",{id:caretContainerId,"data-mce-bogus":true},invisibleChar);if(before){target.parentNode.insertBefore(caretContainer,target)}else{dom.insertAfter(caretContainer,target)}rng.setStart(caretContainer.firstChild,1);rng.collapse(true);selection.setRng(rng);return caretContainer}function removeCaretContainer(caretContainer){var child,currentCaretContainer,lastContainer;if(caretContainer){rng=selection.getRng(true);rng.setStartBefore(caretContainer);rng.setEndBefore(caretContainer);child=findFirstTextNode(caretContainer);if(child&&child.nodeValue.charAt(0)==invisibleChar){child=child.deleteData(0,1)}dom.remove(caretContainer,true);selection.setRng(rng)}else{currentCaretContainer=getParentCaretContainer(selection.getStart());while((caretContainer=dom.get(caretContainerId))&&caretContainer!==lastContainer){if(currentCaretContainer!==caretContainer){child=findFirstTextNode(caretContainer);if(child&&child.nodeValue.charAt(0)==invisibleChar){child=child.deleteData(0,1)}dom.remove(caretContainer,true)}lastContainer=caretContainer}}}function moveSelection(){var nonEditableStart,nonEditableEnd,isCollapsed,rng,element;function hasSideContent(element,left){var container,offset,walker,node,len;container=rng.startContainer;offset=rng.startOffset;if(container.nodeType==3){len=container.nodeValue.length;if(offset>0&&offset<len||(left?offset==len:offset==0)){return}}else{if(offset<container.childNodes.length){var pos=!left&&offset>0?offset-1:offset;container=container.childNodes[pos];if(container.hasChildNodes()){container=container.firstChild}}else{return!left?element:null}}walker=new TreeWalker(container,element);while(node=walker[left?"prev":"next"]()){if(node.nodeType===3&&node.nodeValue.length>0){return}else if(getContentEditable(node)==="true"){return node}}return element}removeCaretContainer();isCollapsed=selection.isCollapsed();nonEditableStart=getNonEditableParent(selection.getStart());nonEditableEnd=getNonEditableParent(selection.getEnd());if(nonEditableStart||nonEditableEnd){rng=selection.getRng(true);if(isCollapsed){nonEditableStart=nonEditableStart||nonEditableEnd;var start=selection.getStart();if(element=hasSideContent(nonEditableStart,true)){insertCaretContainerOrExpandToBlock(element,true)}else if(element=hasSideContent(nonEditableStart,false)){insertCaretContainerOrExpandToBlock(element,false)}else{selection.select(nonEditableStart)}}else{rng=selection.getRng(true);if(nonEditableStart){rng.setStartBefore(nonEditableStart)}if(nonEditableEnd){rng.setEndAfter(nonEditableEnd)}selection.setRng(rng)}}}function handleKey(ed,e){var keyCode=e.keyCode,nonEditableParent,caretContainer,startElement,endElement;function getNonEmptyTextNodeSibling(node,prev){while(node=node[prev?"previousSibling":"nextSibling"]){if(node.nodeType!==3||node.nodeValue.length>0){return node}}}function positionCaretOnElement(element,start){selection.select(element);selection.collapse(start)}function canDelete(backspace){var rng,container,offset,nonEditableParent;function removeNodeIfNotParent(node){var parent=container;while(parent){if(parent===node){return}parent=parent.parentNode}dom.remove(node);moveSelection()}function isNextPrevTreeNodeNonEditable(){var node,walker,nonEmptyElements=ed.schema.getNonEmptyElements();walker=new tinymce.dom.TreeWalker(container,ed.getBody());while(node=backspace?walker.prev():walker.next()){if(nonEmptyElements[node.nodeName.toLowerCase()]){break}if(node.nodeType===3&&tinymce.trim(node.nodeValue).length>0){break}if(getContentEditable(node)==="false"){removeNodeIfNotParent(node);return true}}if(getNonEditableParent(node)){return true}return false}if(selection.isCollapsed()){rng=selection.getRng(true);container=rng.startContainer;offset=rng.startOffset;container=getParentCaretContainer(container)||container;if(nonEditableParent=getNonEditableParent(container)){removeNodeIfNotParent(nonEditableParent);return false}if(container.nodeType==3&&(backspace?offset>0:offset<container.nodeValue.length)){return true}if(container.nodeType==1){container=container.childNodes[offset]||container}if(isNextPrevTreeNodeNonEditable()){return false}}return true}startElement=selection.getStart();endElement=selection.getEnd();nonEditableParent=getNonEditableParent(startElement)||getNonEditableParent(endElement);if(nonEditableParent&&(keyCode<112||keyCode>124)&&keyCode!=VK.DELETE&&keyCode!=VK.BACKSPACE){if((tinymce.isMac?e.metaKey:e.ctrlKey)&&(keyCode==67||keyCode==88||keyCode==86)){return}e.preventDefault();if(keyCode==VK.LEFT||keyCode==VK.RIGHT){var left=keyCode==VK.LEFT;if(ed.dom.isBlock(nonEditableParent)){var targetElement=left?nonEditableParent.previousSibling:nonEditableParent.nextSibling;var walker=new TreeWalker(targetElement,targetElement);var caretElement=left?walker.prev():walker.next();positionCaretOnElement(caretElement,!left)}else{positionCaretOnElement(nonEditableParent,left)}}}else{if(keyCode==VK.LEFT||keyCode==VK.RIGHT||keyCode==VK.BACKSPACE||keyCode==VK.DELETE){caretContainer=getParentCaretContainer(startElement);if(caretContainer){if(keyCode==VK.LEFT||keyCode==VK.BACKSPACE){nonEditableParent=getNonEmptyTextNodeSibling(caretContainer,true);if(nonEditableParent&&getContentEditable(nonEditableParent)==="false"){e.preventDefault();if(keyCode==VK.LEFT){positionCaretOnElement(nonEditableParent,true)}else{dom.remove(nonEditableParent);return}}else{removeCaretContainer(caretContainer)}}if(keyCode==VK.RIGHT||keyCode==VK.DELETE){nonEditableParent=getNonEmptyTextNodeSibling(caretContainer);if(nonEditableParent&&getContentEditable(nonEditableParent)==="false"){e.preventDefault();if(keyCode==VK.RIGHT){positionCaretOnElement(nonEditableParent,false)}else{dom.remove(nonEditableParent);return}}else{removeCaretContainer(caretContainer)}}}if((keyCode==VK.BACKSPACE||keyCode==VK.DELETE)&&!canDelete(keyCode==VK.BACKSPACE)){e.preventDefault();return false}}}}ed.onMouseDown.addToTop(function(ed,e){var node=ed.selection.getNode();if(getContentEditable(node)==="false"&&node==e.target){moveSelection()}});ed.onMouseUp.addToTop(moveSelection);ed.onKeyDown.addToTop(handleKey);ed.onKeyUp.addToTop(moveSelection)}tinymce.create("tinymce.plugins.NonEditablePlugin",{init:function(ed,url){var editClass,nonEditClass,nonEditableRegExps;function convertRegExpsToNonEditable(ed,args){var i=nonEditableRegExps.length,content=args.content,cls=tinymce.trim(nonEditClass);if(args.format=="raw"){return}while(i--){content=content.replace(nonEditableRegExps[i],function(match){var args=arguments,index=args[args.length-2];if(index>0&&content.charAt(index-1)=='"'){return match}return'<span class="'+cls+'" data-mce-content="'+ed.dom.encode(args[0])+'">'+ed.dom.encode(typeof args[1]==="string"?args[1]:args[0])+"</span>"})}args.content=content}editClass=" "+tinymce.trim(ed.getParam("noneditable_editable_class","mceEditable"))+" ";nonEditClass=" "+tinymce.trim(ed.getParam("noneditable_noneditable_class","mceNonEditable"))+" ";nonEditableRegExps=ed.getParam("noneditable_regexp");if(nonEditableRegExps&&!nonEditableRegExps.length){nonEditableRegExps=[nonEditableRegExps]}ed.onPreInit.add(function(){handleContentEditableSelection(ed);if(nonEditableRegExps){ed.selection.onBeforeSetContent.add(convertRegExpsToNonEditable);ed.onBeforeSetContent.add(convertRegExpsToNonEditable)}ed.parser.addAttributeFilter("class",function(nodes){var i=nodes.length,className,node;while(i--){node=nodes[i];className=" "+node.attr("class")+" ";if(className.indexOf(editClass)!==-1){node.attr(internalName,"true")}else if(className.indexOf(nonEditClass)!==-1){node.attr(internalName,"false")}}});ed.serializer.addAttributeFilter(internalName,function(nodes,name){var i=nodes.length,node;while(i--){node=nodes[i];if(nonEditableRegExps&&node.attr("data-mce-content")){node.name="#text";node.type=3;node.raw=true;node.value=node.attr("data-mce-content")}else{node.attr(externalName,null);node.attr(internalName,null)}}});ed.parser.addAttributeFilter(externalName,function(nodes,name){var i=nodes.length,node;while(i--){node=nodes[i];node.attr(internalName,node.attr(externalName));node.attr(externalName,null)}})})},getInfo:function(){return{longname:"Non editable elements",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/noneditable",version:tinymce.majorVersion+"."+tinymce.minorVersion}}});tinymce.PluginManager.add("noneditable",tinymce.plugins.NonEditablePlugin)})();